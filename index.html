<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>ZIP Downloader</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f0f4f8;
            color: #333;
            padding: 20px;
            display: flex;
            justify-content: center;
        }

        .container {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
            max-width: 700px;
            width: 100%;
        }

        h2 {
            text-align: center;
            margin-bottom: 10px;
        }

        p,
        ol {
            line-height: 1.6;
            color: #555;
        }

        input[type="text"],
        input[type="password"] {
            width: 100%;
            padding: 10px;
            margin: 8px 0;
            border-radius: 6px;
            border: 1px solid #ccc;
            font-size: 1em;
            box-sizing: border-box;
        }

        button {
            width: 100%;
            font-size: 1.1em;
            padding: 12px;
            margin-top: 8px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
        }

        #decompressBtn {
            background-color: #e67e22;
            color: white;
        }

        #decompressBtn:hover {
            background-color: #d35400;
        }

        #downloadBtn {
            background-color: #3498db;
            color: white;
        }

        #downloadBtn:hover {
            background-color: #2980b9;
        }

        textarea {
            width: 100%;
            height: 150px;
            margin-top: 12px;
            resize: none;
            border-radius: 6px;
            border: 1px solid #ccc;
            padding: 10px;
            font-family: monospace;
            background: #f7f9fb;
            color: #333;
        }

        #fotoContainer img {
            max-width: 120px;
            margin: 5px;
            border-radius: 6px;
            border: 1px solid #ccc;
        }

        #result {
            display: none;
        }
    </style>
    <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script> -->
</head>

<body>
    <div class="container">
        <h2>ZIP Downloader</h2>
        <p>Prosedur penggunaan:</p>
        <ol>
            <li>Scan QR Code untuk membuka halaman ini.</li>
            <li>Masukkan password ZIP pada kotak input (jika ada).</li>
            <li>Pilih "Download & Dekompresi" untuk membuka ZIP di browser.</li>
            <li>Atau pilih "Download ZIP Mentah" untuk langsung download file ZIP.</li>
            <li>Periksa kotak log untuk status dan pesan error.</li>
        </ol>

        <p><strong>File ID:</strong> <span id="fileIdDisplay">-</span></p>
        <p><strong>URL file ZIP Google Drive:</strong></p>
        <input type="text" id="fileUrlDisplay" readonly>

        <input type="text" id="password" placeholder="Masukkan password ZIP">

        <button id="decompressBtn">Download & Dekompresi</button>
        <button id="downloadBtn">Download ZIP Mentah</button>

        <p><strong>Log:</strong></p>
        <textarea id="logBox" readonly></textarea>

        <div id="result" style="margin-top:20px;">
            <h3>Belum ada text</h3>
            <pre id="resultText"></pre>
            <h3>Hasil Foto</h3>
            <div id="resultImages"></div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/@zip.js/zip.js/dist/zip.js"></script>
    <script>
        // Ambil fileId dari URL (opsional)
        function getFileIdFromURL() {
            const params = new URLSearchParams(window.location.search);
            return params.get("fileId");
        }

        function writeLog(msg, type = "info") {
            const logBox = document.getElementById('logBox');
            const time = new Date().toLocaleTimeString();
            const prefix = type === "error" ? "[ERROR]" : type === "success" ? "[OK]" : "[INFO]";
            logBox.value += `${prefix} ${time} - ${msg}\n`;
            logBox.scrollTop = logBox.scrollHeight;
        }

        function setLoading(isLoading) {
            const btn = document.getElementById("decompressBtn");
            btn.disabled = isLoading;
            btn.textContent = isLoading ? "Memproses..." : "Download & Dekompresi";
        }

        // Fungsi download & dekompresi dari GAS
        async function downloadAndDecompress() {

            const password = document.getElementById("password").value.trim();
            if (!password) {
                writeLog("Password harus diisi!", "error");
                return;
            }

            setLoading(true);
            writeLog("Mengambil file ZIP dari Google Drive...");


            try {
                const fileId = "1GiHPU7ndi4VgX1kUatk1RNd0NGpe8aD0"; // dummy, ganti dari URL
                const url = `https://script.google.com/macros/s/AKfycbzp0ofbZfgvagXAdr5rjqTTaLcGJqRUyM42WFcJdh19vaC6ce8de64Xwsfoe3V0r2hecQ/exec?fileId=${fileId}`;

                const res = await fetch(url);
                if (!res.ok) throw new Error("Gagal fetch ZIP dari GAS");
                const json = await res.json();

                // decode base64 â†’ Uint8Array
                const binary = atob(json.data);
                const arrayBuffer = new Uint8Array(binary.length);
                for (let i = 0; i < binary.length; i++) {
                    arrayBuffer[i] = binary.charCodeAt(i);
                }

                // Buka ZIP dengan password
                const blob = new Blob([arrayBuffer], {
                    type: "application/zip"
                });
                const reader = new zip.ZipReader(new zip.BlobReader(blob));

                const entries = await reader.getEntries({
                    password
                });
                if (entries.length === 0) {
                    throw new Error("ZIP kosong atau password salah");
                }

                let teksDitemukan = false;
                let gambarDitemukan = false;
                for (const entry of entries) {
                    if (entry.filename.endsWith(".txt")) {
                        const text = await entry.getData(new zip.TextWriter(), {
                            password
                        });
                        document.getElementById("resultText").textContent = text;
                        teksDitemukan = true;
                    } else if (/\.(jpg|jpeg|png|gif)$/i.test(entry.filename)) {
                        const imgBlob = await entry.getData(new zip.BlobWriter(), {
                            password
                        });
                        const url = URL.createObjectURL(imgBlob);
                        
                        const img = document.createElement("img");
                        img.src = url;
                        img.alt = entry.filename;
                        img.style.maxWidth = "200px";
                        img.style.margin = "5px";
                        document.getElementById("resultImages").appendChild(img);
                        gambarDitemukan = true;
                    }
                }

                if (teksDitemukan || gambarDitemukan) {
                    document.getElementById("result").style.display = "block";
                    writeLog("Dekompresi berhasil!", "success");
                } else {
                    writeLog("Tidak ada file teks ditemukan!", "error");
                }

                await reader.close();
            } catch (err) {
                writeLog(err.message, "error");
            } finally {
                setLoading(false);
            }
        }

        // Download ZIP langsung dari Google Drive
        function downloadZIPDirect() {
            const fileId = '1GiHPU7ndi4VgX1kUatk1RNd0NGpe8aD0'; // contoh dummy
            if (!fileId) {
                writeLog("URL kosong atau ID file tidak valid!", "error");
                return;
            }
            const url = `https://drive.google.com/uc?id=${fileId}&export=download`;
            window.open(url, "_blank");
            writeLog("Memulai download ZIP langsung...");
        }

        // Bind tombol setelah DOM ready
        window.addEventListener('DOMContentLoaded', () => {
            const fileId = '1GiHPU7ndi4VgX1kUatk1RNd0NGpe8aD0'; // contoh dummy
            document.getElementById('fileIdDisplay').textContent = fileId || "-";
            document.getElementById('fileUrlDisplay').value = fileId ?
                `https://drive.google.com/uc?id=${fileId}&export=download` : "-";

            document.getElementById('decompressBtn').onclick = downloadAndDecompress;
            document.getElementById('downloadBtn').onclick = downloadZIPDirect;
        });
    </script>
</body>

</html>
