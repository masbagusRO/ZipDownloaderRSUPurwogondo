<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>ZIP Downloader</title>
    <style>
        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f0f4f8;
            color: #333;
            padding: 20px;
            display: flex;
            justify-content: center;
        }

        .container {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
            max-width: 700px;
            width: 100%;
        }

        h2 {
            text-align: center;
            margin-bottom: 10px;
        }

        p,
        ol {
            line-height: 1.6;
            color: #555;
        }

        input[type="text"],
        input[type="password"] {
            width: 100%;
            padding: 10px;
            margin: 8px 0;
            border-radius: 6px;
            border: 1px solid #ccc;
            font-size: 1em;
            box-sizing: border-box;
        }

        button {
            width: 100%;
            font-size: 1.1em;
            padding: 12px;
            margin-top: 8px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
        }

        #decompressBtn {
            background-color: #e67e22;
            color: white;
        }

        #decompressBtn:hover {
            background-color: #d35400;
        }

        #downloadBtn {
            background-color: #3498db;
            color: white;
        }

        #downloadBtn:hover {
            background-color: #2980b9;
        }

        textarea {
            width: 100%;
            height: 150px;
            margin-top: 12px;
            resize: none;
            border-radius: 6px;
            border: 1px solid #ccc;
            padding: 10px;
            font-family: monospace;
            background: #f7f9fb;
            color: #333;
        }

        #fotoContainer img {
            max-width: 120px;
            margin: 5px;
            border-radius: 6px;
            border: 1px solid #ccc;
        }

        #result {
            display: none;
            font-size: 10px;
            border: 1px dashed black;
        }

        /* --- Kop surat --- */
        .kop-surat {
            /* background-color: #3498db; */
            display: grid;
            grid-template-columns: 100px auto;
            gap: 5px;
            border-bottom: 2px solid black;
            /* margin-bottom: 10px; */
        }

        .kop-surat .logo img {
            width: 90px;
        }

        .kop-surat .instansi {
            /* grid-column: 2; */
            text-align: right;
            line-height: 0.01;
        }

        .kop-surat .instansi h1 {
            font-size: 14pt;
            /* margin-bottom: 10px; */
        }

        /* identitas pasien */
        /* --- Tabel identitas pasien --- */
        #IdentitasPasien {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
        }

        #IdentitasPasien col:nth-child(1) {
            width: 80px;
        }

        #IdentitasPasien col:nth-child(2) {
            width: 10px;
        }

        #IdentitasPasien col:nth-child(3) {
            width: 170px;
        }

        #IdentitasPasien col:nth-child(4) {
            width: 120px;
        }

        #IdentitasPasien col:nth-child(5) {
            width: 10px;
        }

        #IdentitasPasien col:nth-child(6) {
            width: 170px;
        }

        #IdentitasPasien td {
            padding: 4px;
            vertical-align: top;
            word-break: break-word;
            overflow-wrap: break-word;
        }

        #IdentitasPasien td:nth-child(2),
        #IdentitasPasien td:nth-child(5) {
            text-align: center;
            white-space: nowrap;
        }

        #HasilPemeriksaan {
            border: 1px solid black;
            padding: 5px;
            white-space: pre-wrap;
            word-break: break-word;
            overflow-wrap: break-word;
            margin: 10px 0;
            margin: 0 5px;
        }

        /* --- Tabel petugas --- */
        #KolomPetugas {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
            margin-top: 15px;
        }
    </style>
    <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script> -->
</head>

<body>
    <script>
        //sering tidak support kalau bukan chrome/firefox
    if (!/Chrome|Firefox/.test(navigator.userAgent)) {
    alert("Disarankan menggunakan Chrome atau Firefox untuk menampilkan gambar.");
}
    </script>
    <div class="container">
        <h2>Radiologi RSU purwogondo</h2>
        <p>Prosedur penggunaan:</p>
        <ol>
            <li>Hanya dapat digunakan oleh pasien RSU purwogondo</li>
            <li>Masukkan password pada kotak input</li>
            <li>Pilih "Proses" untuk melihat hasil roentgen di browser.</li>
            <li>Atau pilih "Download ZIP" untuk langsung download file roentgen.</li>
            <li>Periksa kotak log untuk status dan pesan error.</li>
            <li>disarankan menekan tombol "download zip" jika terjadi error pada tombol "lihat"</li>
            <li>password ada di kertas yang diberikan oleh petugas radiologi</li>
        </ol>

        <p><strong>File ID:</strong> <span id="fileIdDisplay">-</span></p>
        <p><strong>URL file ZIP Google Drive:</strong></p>
        <input type="text" id="fileUrlDisplay" readonly>

        <input type="text" id="password" placeholder="Masukkan password">

        <button id="decompressBtn">Proses</button>
        <button id="downloadBtn">Download ZIP</button>

        <p><strong>Log:</strong></p>
        <textarea id="logBox" readonly></textarea>

        <div id="result" style="margin-top:20px;">
            <div class="kop-surat">
                <!-- <div class="logo">{{{logoHtml}}}</div> -->
                <div class="logo"><img
                        src="https://raw.githubusercontent.com/masbagusRO/ZipDownloaderRSUPurwogondo/refs/heads/main/logo.webp"
                        alt="RSU PWG"></div>
                <div class="instansi">
                    <h1>RSU PURWOGONDO</h1>
                    <p>Jl. Puring km.8 Kalipurwo, Kuwarasan, Kebumen, Jawa Tengah</p>
                    <p>(0287) 472588 / 4760192</p>
                    <p>Email: rsu.purwogondo@yahoo.co.id</p>
                </div>
            </div>
            <p style="text-align: center; margin-bottom: 5pt; font-weight: bold;">Hasil Pemeriksaan Radiologi</p>
            <table id="IdentitasPasien">
                <colgroup>
                    <col>
                    <col>
                    <col>
                    <col>
                    <col>
                    <col>
                </colgroup>
                <tbody>
                    <tr>
                        <td>No. RM</td>
                        <td>:</td>
                        <td id="NoRM">{{NoRM}}</td>
                        <td>Penanggung Jawab</td>
                        <td>:</td>
                        <td id="DokterRadiologi">{{DokterRadiologi}}</td>
                    </tr>
                    <tr>
                        <td>Nama</td>
                        <td>:</td>
                        <td id="Nama">{{Nama}}</td>
                        <td>Dokter Pengirim</td>
                        <td>:</td>
                        <td id="DokterPengirim">{{DokterPengirim}}</td>
                    </tr>
                    <tr>
                        <td>JK/Umur</td>
                        <td>:</td>
                        <td><span id="JK">{{JK}}</span> / <span id="Umur">{{Umur}}</span></td>
                        <td>Tgl.Pemeriksaan</td>
                        <td>:</td>
                        <td id="TglPemeriksaan">{{TglPemeriksaan}}</td>
                    </tr>
                    <tr>
                        <td>Alamat</td>
                        <td>:</td>
                        <td id="Alamat">{{Alamat}}</td>
                        <td>Jam Pemeriksaan</td>
                        <td>:</td>
                        <td id="JamPemeriksaan">{{JamPemeriksaan}}</td>
                    </tr>
                    <tr>
                        <td>No. Periksa</td>
                        <td>:</td>
                        <td id="NoPeriksa">{{NoPeriksa}}</td>
                        <td>Poli/Kamar</td>
                        <td>:</td>
                        <td id="Ruangan">{{Ruangan}}</td>
                    </tr>
                    <tr>
                        <td>Pemeriksaan</td>
                        <td>:</td>
                        <td colspan="4" id="Pemeriksaan">{{Pemeriksaan}}</td>
                    </tr>
                </tbody>
            </table>
            <p style="margin-top: 10px;">Hasil Pemeriksaan :</p>
            <div>
                <pre id="HasilPemeriksaan">{{HasilPemeriksaan}}</pre>
            </div>
            <table id="KolomPetugas">
                <colgroup>
                    <col>
                    <col>
                </colgroup>
                <tbody>
                    <tr>
                        <!-- <td style="text-align: left;">Tgl. Cetak {{tglCetak}}</td> -->
                        <td>Tgl. Upload <span id="tglUpload">{{tglUpload}}</span></td>
                        <td></td>
                    </tr>
                    <tr>
                        <td>Penanggung Jawab</td>
                        <td>Petugas Radiologi</td>
                    </tr>
                    <tr>
                        <td id="DokterRadiologi1">{{DokterRadiologi}}</td>
                        <td id="PetugasRadiologi">{{PetugasRadiologi}}</td>
                    </tr>
                    <tr>
                        <td colspan="2" style="text-align: center; padding-top: 10px;"><strong>!!! <br> Web ini
                                Digunakan untuk membantu melihat hasil radiologi. Untuk hasil yang resmi, mintalah ke
                                petugas radiologi RSU Purwogondo <br>!!!</strong></td>
                    </tr>
                </tbody>
            </table>
            <p><b>klik gambar untuk melihat gambar di tab baru</b></p>
            <div id="resultImages"></div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/@zip.js/zip.js/dist/zip.js"></script>
<script>

    
    // ================================
    // Ambil fileId dari URL
    // ================================
    function getFileIdFromURL() {
        try {
            const params = new URLSearchParams(window.location.search);
            const fileId = params.get("fileId");

            if (!fileId) {
                throw new Error("fileId tidak ditemukan di URL.");
            }

            return fileId;
        } catch (err) {
            console.error("Gagal mengambil fileId:", err.message);
            return null;
        }
    }

    let fileId;

    // ================================
    // Logging helper
    // ================================
    function writeLog(msg, type = "info") {
        const logBox = document.getElementById('logBox');
        const time = new Date().toLocaleTimeString();
        const prefix =
            type === "error" ? "[ERROR]" :
            type === "success" ? "[OK]" : "[INFO]";
        logBox.value += `${prefix} ${time} - ${msg}\n`;
        logBox.scrollTop = logBox.scrollHeight;
    }

    // ================================
    // Loading state
    // ================================
    function setLoading(isLoading) {
        const btn = document.getElementById("decompressBtn");
        btn.disabled = isLoading;
        btn.textContent = isLoading ? "Memproses..." : "Download & Dekompresi";
    }

    // ================================
    // Isi data pasien dari TXT
    // ================================
    function isiDataPasien(text) {
        const lines = text.split(/\r?\n/);
        let section = null;
        let hasilPemeriksaan = [];

        lines.forEach(line => {
            if (line.startsWith("===")) {
                if (line.includes("Identitas")) section = "identitas";
                else if (line.includes("HasilPemeriksaan")) section = "hasil";
                return;
            }

            if (section === "identitas") {
                const [key, ...rest] = line.split(":");
                if (!key || !rest.length) return;

                const value = rest.join(":").trim();
                const cleanKey = key.trim().replace(/\s+/g, "");
                const el = document.getElementById(cleanKey);
                if (el) el.textContent = value;
            } else if (section === "hasil") {
                hasilPemeriksaan.push(line);
            }
        });

        if (hasilPemeriksaan.length > 0) {
            let hasilText = hasilPemeriksaan.join("\n").replace(/\t/g, "    ");
            document.getElementById("HasilPemeriksaan").textContent = hasilText;
        }
    }

    // ================================
    // Base64 → Uint8Array
    // ================================
    function base64ToUint8Array(base64) {
        if (!base64 || typeof base64 !== "string") {
            throw new Error("Base64 tidak valid atau kosong");
        }
        base64 = base64.replace(/\s/g, "");
        while (base64.length % 4 !== 0) base64 += "=";

        try {
            const binary = atob(base64);
            const bytes = new Uint8Array(binary.length);
            for (let i = 0; i < binary.length; i++) {
                bytes[i] = binary.charCodeAt(i);
            }
            return bytes;
        } catch (err) {
            throw new Error("Gagal decode base64: " + err.message);
        }
    }

    // ================================
    // Tampilkan gambar dari ZIP
    // ================================
    async function tampilkanGambar(entry, password, containerId) {
        try {
            const imgBlob = await entry.getData(new zip.BlobWriter(), { password });
            if (!imgBlob) throw new Error("Blob kosong");

            let mimeType = imgBlob.type;
            const filename =entry.filename.trim();
            if (!mimeType || mimeType === "application/octet-stream") {
                if (/\.jpe?g$/i.test(filename)) mimeType = "image/jpeg";
                else if (/\.png$/i.test(filename)) mimeType = "image/png";
                else if (/\.webp$/i.test(filename)) mimeType = "image/webp";
                else if (/\.gif$/i.test(filename)) mimeType = "image/gif";
            }

            const url = URL.createObjectURL(new Blob([imgBlob], { type: mimeType }));

            const link = document.createElement("a");
            link.href = url;
            link.target = "_blank";
            link.rel = "noopener noreferrer";

            const img = document.createElement("img");
            img.src = url;
            img.alt = entry.filename;
            img.style.maxWidth = "200px";
            img.style.margin = "5px";

            link.appendChild(img);
            document.getElementById(containerId).appendChild(link);
        } catch (err) {
            writeLog(`Gagal menampilkan gambar ${entry.filename}: ${err.message}`, "error");
        }
    }

    // ================================
    // Download & dekompresi
    // ================================
    async function downloadAndDecompress() {
        const password = document.getElementById("password").value.trim();
        if (!password) {
            writeLog("Password harus diisi!", "error");
            return;
        }

        if (!fileId) {
            writeLog("FileId kosong! Pastikan URL memiliki ?fileId=xxx", "error");
            return;
        }

        setLoading(true);
        writeLog("Mengambil file ZIP dari Google Drive...");

        try {
            const url = `https://script.google.com/macros/s/AKfycbx7SKC07GhMapbyhVCl-e7IswbfXLlKrOxbG2MmduFi6QcWhxxKVWVHbYWr28sU_8UVmw/exec?fileId=${fileId}`;

            const res = await fetch(url);
            if (!res.ok) throw new Error("Gagal fetch ZIP dari GAS");

            const json = await res.json();
            if (!json.success || !json.data) {
                throw new Error(json.message || "Data base64 kosong / tidak valid");
            }

            const arrayBuffer = base64ToUint8Array(json.data);

            // Reset hasil lama
            document.getElementById("resultImages").innerHTML = "";
            document.getElementById("HasilPemeriksaan").textContent = "";

            // Buka ZIP
            const blob = new Blob([arrayBuffer], { type: "application/zip" });
            const reader = new zip.ZipReader(new zip.BlobReader(blob));

            const entries = await reader.getEntries({ password });
            if (entries.length === 0) {
                throw new Error("ZIP kosong atau password salah");
            }

            let teksDitemukan = false;
            let gambarDitemukan = false;

            for (const entry of entries) {
                if (entry.filename.endsWith(".txt")) {
                    const text = await entry.getData(new zip.TextWriter(), { password });
                    isiDataPasien(text);
                    teksDitemukan = true;
                } else if (/\.(jpg|jpeg|png|gif|webp)$/i.test(entry.filename)) {
                    await tampilkanGambar(entry, password, "resultImages");
                    gambarDitemukan = true;
                }
            }

            if (teksDitemukan || gambarDitemukan) {
                document.getElementById("result").style.display = "block";
                writeLog("Dekompresi berhasil!", "success");
            } else {
                writeLog("Tidak ada file teks atau gambar ditemukan!", "error");
            }

            await reader.close();
        } catch (err) {
            writeLog(err.message, "error");
        } finally {
            setLoading(false);
        }
    }

    // ================================
    // Download langsung ZIP dari Drive
    // ================================
    function downloadZIPDirect() {
        if (!fileId) {
            writeLog("URL kosong atau ID file tidak valid!", "error");
            return;
        }
        const url = `https://drive.google.com/uc?id=${fileId}&export=download`;
        window.open(url, "_blank");
        writeLog("Memulai download ZIP langsung...");
    }

    // ================================
    // Init saat DOM ready
    // ================================
    window.addEventListener('DOMContentLoaded', () => {
        fileId = getFileIdFromURL();
        document.getElementById('fileIdDisplay').textContent = fileId || "-";
        document.getElementById('fileUrlDisplay').value = fileId ?
            `https://drive.google.com/uc?id=${fileId}&export=download` : "-";

        document.getElementById('decompressBtn').onclick = downloadAndDecompress;
        document.getElementById('downloadBtn').onclick = downloadZIPDirect;
    });
</script>



</body>

</html>
